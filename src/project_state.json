{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 3,
  "summary": "Inner Bloom is a React + TypeScript single-page meditation companion backed by a Motoko canister on the Internet Computer. It supports Internet Identity authentication plus a guest/offline mode that persists meditation data in localStorage. Users can select a meditation type (or take a recommendation quiz), follow step-by-step guides, choose duration and ambient audio, run a timed meditation (pause/seek/volume with audio fade-out), then record a post-session reflection (moods, energy, notes, favorite) into a journal. The app tracks progress (total minutes, streak, last-30-days minutes), derives rank tiers aligned to a 0–20,000-minute cap, renders progress visuals (animated canvas bowl; lotus background; progress lotus via SVG and optional 3D R3F), and provides unified JSON export/import (guest uses localStorage; authenticated users use canister export/import). A curated book recommendations page is served from a static frontend dataset (Amazon links).",
  "existing_features": [
    {
      "id": "IF-1",
      "title": "Internet Identity authentication context",
      "synonyms": [
        "InternetIdentityProvider",
        "useInternetIdentity",
        "AuthClient integration"
      ],
      "description": "Provides Internet Identity login/logout, loads persisted identity on startup, and exposes detailed status flags (initializing/idle/logging-in/success/error) for UI gating.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-2",
      "title": "Identity-bound canister actor creation, initialization, and cache invalidation",
      "synonyms": [
        "useActor",
        "createActorWithConfig",
        "actor cache"
      ],
      "description": "Creates an anonymous actor for guests and an identity-bound actor for authenticated users; on actor creation it calls backend RBAC initialization and invalidates/refetches non-actor React Query data when the actor changes.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-3",
      "title": "Secure secret handling via URL hash + sessionStorage",
      "synonyms": [
        "getSecretParameter",
        "getSecretFromHash",
        "urlParams utilities"
      ],
      "description": "Reads sensitive parameters from the URL hash fragment, persists them in sessionStorage for the session, and removes them from the URL to reduce leakage through history/referrers.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-4",
      "title": "Motoko role-based access control (RBAC) and admin bootstrap",
      "synonyms": [
        "authorization/access-control.mo",
        "MixinAuthorization",
        "getCallerUserRole",
        "assignCallerUserRole"
      ],
      "description": "Implements roles (admin/user/guest), first-user admin bootstrap gated by an env token plus user-provided secret, role queries, admin checks, and admin-only role assignment.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-5",
      "title": "Motoko blob-storage maintenance endpoints",
      "synonyms": [
        "blob-storage/Mixin.mo",
        "_caffeineStorageRefillCashier",
        "_caffeineStorageBlobsToDelete"
      ],
      "description": "Provides endpoints to update authorized gateway principals, list/prune dead blobs, check blob liveness, and refill a cashier canister with cycles (restricted to the cashier principal).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-6",
      "title": "SPA routing with TanStack Router",
      "synonyms": [
        "RouterProvider",
        "createRouter",
        "manual route tree"
      ],
      "description": "Defines navigation across Landing, Dashboard, Pre-Meditation, Progress, Journal, and Books pages using TanStack Router with a manually built route tree.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-7",
      "title": "Theme system (dark/light) using OKLCH design tokens",
      "synonyms": [
        "next-themes",
        "Tailwind CSS variables",
        "theme toggle"
      ],
      "description": "App-wide dark/light theming via OKLCH CSS variables mapped into Tailwind colors; pages/components include theme toggles and theme-aware styling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-8",
      "title": "Global styling utilities and animations",
      "synonyms": [
        "Tailwind config",
        "src/index.css",
        "custom keyframes"
      ],
      "description": "Defines typography (Playfair Display), OKLCH token sets, and reusable animations (fade-in, breathe, glow-pulse, slide-in, float) used across the UI.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-9",
      "title": "Guest mode persistence with localStorage and legacy-key migration",
      "synonyms": [
        "meditationStorage",
        "offline mode",
        "guest-prefixed keys"
      ],
      "description": "Stores guest journal entries and progress under guest-prefixed localStorage keys, migrates legacy keys, and provides helpers for CRUD and progress updates (streak, monthly minutes, session list).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-10",
      "title": "Landing page with login and guest entry",
      "synonyms": [
        "LandingPage",
        "Start Your Journey",
        "Explore as Guest"
      ],
      "description": "Branded landing page with lotus background, theme toggle, Internet Identity login CTA, guest-mode entry, and auto-redirect to dashboard when authenticated.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-11",
      "title": "Dashboard with daily inspiration, meditation selection, quiz entry, and navigation",
      "synonyms": [
        "DashboardPage",
        "MeditationCarousel",
        "FloatingNav"
      ],
      "description": "Displays a random daily quote fetched from the backend, a meditation-type selector carousel (including quiz option), a Begin action to start the flow, plus persistent floating navigation and mobile hamburger menu.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-12",
      "title": "Daily quotes feed (principal-scoped caching)",
      "synonyms": [
        "useDailyQuotes",
        "getDailyQuotes"
      ],
      "description": "Fetches a list of inspirational quotes from the backend and caches results per principal/guest with a short stale time; dashboard selects a random quote to display.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-13",
      "title": "Meditation type selector carousel",
      "synonyms": [
        "MeditationCarousel",
        "type picker"
      ],
      "description": "Carousel for selecting meditation types (Mindfulness/Metta/Visualization/IFS) or entering a quiz flow, with prev/next navigation and a “Recommended” badge for Mindfulness when centered.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-14",
      "title": "Meditation recommendation quiz",
      "synonyms": [
        "QuizDialog",
        "recommendation flow"
      ],
      "description": "Modal quiz with 5 questions that scores answers to recommend a meditation type (with tie-breaking) and routes the user into the pre-meditation flow using the recommendation.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-15",
      "title": "Meditation types catalog (frontend mock)",
      "synonyms": [
        "useMeditationTypes",
        "mockMeditationTypes"
      ],
      "description": "Provides meditation type metadata (name/description/guide) from a frontend mock dataset because the backend does not expose a meditation-types endpoint.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-16",
      "title": "Step-by-step meditation guide stepper (responsive + benefits hierarchy)",
      "synonyms": [
        "MeditationGuideStepper",
        "clickable step dots",
        "slide animations"
      ],
      "description": "Renders guided steps with Previous/Next navigation, clickable indicator dots, direction-aware slide animations, responsive layout (mobile stacking), and parsing of a 'Benefits:' section into a distinct block with heading/icon.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-17",
      "title": "Pre-meditation setup + active session + reflection flow (single-page state machine)",
      "synonyms": [
        "PreMeditationPage",
        "setup/active/reflection views"
      ],
      "description": "Implements a three-state meditation experience: setup (guide, duration slider, ambient selection), active timed meditation, and post-session reflection capture with save-and-return to dashboard.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-18",
      "title": "Ambient sound carousel with preview, volume and mute",
      "synonyms": [
        "AmbientMusicCarousel",
        "audio preview carousel"
      ],
      "description": "Carousel for ambient tracks with looping preview audio, start-from-middle behavior after metadata loads, mute toggle, volume slider, and cleanup on selection change/unmount.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-19",
      "title": "Active meditation timer with pause, seek, and volume controls",
      "synonyms": [
        "in-session timer",
        "countdown ring"
      ],
      "description": "Runs a countdown timer for the chosen duration with pause/resume, seek slider, volume control, animated SVG progress ring with glow, and smooth ambient audio fade-out on completion.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-20",
      "title": "Post-session reflection capture and journal save mutation",
      "synonyms": [
        "reflection flow",
        "mood/energy capture"
      ],
      "description": "Collects multi-select moods, a single energy state, optional notes, and a favorite flag after a session and saves a journal entry via a React Query mutation (currently persisted to guest localStorage due to missing backend mutations).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-21",
      "title": "Session recording and progress tracking (guest + authenticated branching)",
      "synonyms": [
        "useRecordSession",
        "streak tracking"
      ],
      "description": "Records meditation sessions by updating guest localStorage in guest mode or calling backend recordMeditationSession in authenticated mode; invalidates progress queries on success.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-22",
      "title": "Progress stats query with principal-scoped caching",
      "synonyms": [
        "useProgressStats"
      ],
      "description": "Fetches progress stats from the backend (authenticated) or localStorage (guest) using a principal-scoped query key and short stale times to keep progress UI fresh.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-23",
      "title": "Rank tiers aligned to a 0–20,000 minute cap",
      "synonyms": [
        "progressRanks",
        "RANK_TIERS",
        "formatRankDisplay"
      ],
      "description": "Defines rank tiers and helper functions to derive current rank, next rank, minutes-until-next, and a formatted display string; used in UI and in import pipeline rank labeling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-24",
      "title": "Progress page with metrics, rank display, bowl visualization, and data portability",
      "synonyms": [
        "ProgressPage",
        "Your Meditation Journey"
      ],
      "description": "Displays progress metrics (total minutes, streak, monthly minutes), rank and next-rank distance, animated bowl-fill visualization, and export/import actions with confirmation dialog and toast feedback.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-25",
      "title": "Animated bowl-fill progress visualization (canvas)",
      "synonyms": [
        "ProgressBowl",
        "progress bowl canvas"
      ],
      "description": "Theme-aware canvas bowl that fills proportionally to total minutes (capped at 20,000) with layered glow outlines, animated double-wave liquid surface, and increased internal render size/scaling to reduce glow clipping.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-26",
      "title": "Lotus background canvas animation with variants and intensity control",
      "synonyms": [
        "LotusCanvas",
        "default/enhanced/premed variants",
        "intensity prop"
      ],
      "description": "Full-screen decorative canvas animation (lotus + ripples + particles) that adjusts visibility by theme and context (variant) and supports a per-page intensity multiplier for subtlety tuning.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-27",
      "title": "Lotus growth model for progress-driven visuals",
      "synonyms": [
        "calculateLotusGrowth",
        "lotusGrowthModel"
      ],
      "description": "Maps total meditation minutes (0–20,000) into a growth state (phases, 4-layer openness curves, vividness, particle parameters, breathing/presence mode at cap) used by lotus renderers.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-28",
      "title": "SVG lotus progress visualization (layered)",
      "synonyms": [
        "ProgressLotusSVG",
        "layered lotus SVG"
      ],
      "description": "Renders a layered SVG lotus (4 layers, all petals present from start) with progressive opening, glow, subtle breathing/pulsing animations, vividness ramp, and theme-aware coloring driven by the lotus growth model and streak.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-29",
      "title": "3D lotus progress visualization (React Three Fiber)",
      "synonyms": [
        "ProgressLotusR3F",
        "LotusModel",
        "LotusParticles"
      ],
      "description": "Optional WebGL lotus visualization with a 3D lotus mesh, animated center glow, and particle system that transitions from chaotic to coherent motion as progress increases; includes lighting and auto-rotating orbit controls.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-30",
      "title": "Journal entries query with auth/guest branching and unified serialization helpers",
      "synonyms": [
        "useJournalEntries",
        "serialize/deserialize unified format"
      ],
      "description": "Fetches journal entries from the backend for authenticated users or from localStorage for guests; includes unified-format serialization/deserialization helpers for import/export compatibility.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-31",
      "title": "Journal browsing and management UI (search, filters, edit, delete, favorites)",
      "synonyms": [
        "JournalPage",
        "reflection management"
      ],
      "description": "Displays journal entries with search and filters (type/mood/energy), favorites tab, inline reflection editing, delete confirmation, favorite toggling, loading overlays per entry, and export/import actions.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-32",
      "title": "Unified export of meditation data (guest and authenticated)",
      "synonyms": [
        "useExportMeditationData",
        "JSON backup"
      ],
      "description": "Exports a unified JSON file containing journal entries, session records, and progress stats from either localStorage (guest) or the backend export endpoint (authenticated), then downloads the file in-browser.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-33",
      "title": "Unified import of meditation data with overwrite semantics",
      "synonyms": [
        "useImportMeditationData",
        "data restore"
      ],
      "description": "Imports unified JSON and overwrites backend state for authenticated users (actor.importData(..., true)) or overwrites guest localStorage for guests; invalidates journal/progress queries after import.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-34",
      "title": "Book recommendations (static frontend dataset) and carousel page",
      "synonyms": [
        "BOOK_RECOMMENDATIONS",
        "BookRecommendationsPage"
      ],
      "description": "Curated book recommendations from a static frontend dataset with Amazon links, displayed in a themed carousel UI with tags and external link opening.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-35",
      "title": "Session/account indicator with logout cache cleanup",
      "synonyms": [
        "SessionIndicator",
        "guest vs logged-in badge",
        "query cache cleanup"
      ],
      "description": "Displays guest vs authenticated state and provides return-to-start/logout actions; logout clears key React Query caches to reduce cross-session data contamination.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-36",
      "title": "Mobile hamburger menu for theme and account actions",
      "synonyms": [
        "HamburgerMenu",
        "Sheet menu"
      ],
      "description": "Mobile slide-in menu providing theme toggling, guest/logged-in indicators, return-to-start, and logout with authenticated-query cache cleanup.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-37",
      "title": "Mobile back button helper",
      "synonyms": [
        "MobileBackButton"
      ],
      "description": "Mobile-only floating back button that navigates back to the dashboard on small screens.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-38",
      "title": "Floating quick navigation",
      "synonyms": [
        "FloatingNav",
        "side icon nav"
      ],
      "description": "Floating vertical navigation linking to Journal, Progress, and Books with drift animation and hover labels; configured to remain above other UI layers.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-39",
      "title": "Motoko backend APIs for books/quotes, profiles, export/import, and session/progress storage",
      "synonyms": [
        "getDailyQuotes",
        "getBooks",
        "getCallerUserProfile",
        "saveCallerUserProfile",
        "getCurrentUserExportData",
        "importData",
        "recordMeditationSession"
      ],
      "description": "Canister serves static books/quotes, stores per-user profiles and meditation records, provides per-user export of all data and import (overwrite/merge flag), and exposes an authenticated session recording endpoint guarded by RBAC.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-40",
      "title": "UI/UX polish: lotus subtlety, Journal responsive breakpoint, and light-theme readability improvements",
      "synonyms": [
        "lotus intensity tuning",
        "Journal filter breakpoint ~800px",
        "light theme contrast pass"
      ],
      "description": "Reduces lotus background intensity on Dashboard and Pre‑Meditation views via LotusCanvas intensity, adjusts the Journal filter/search container to switch to single-column at ~800px, and improves light-theme border/description-gray contrast in global tokens for readability.",
      "reqIds": [
        "REQ-22",
        "REQ-23",
        "REQ-24"
      ],
      "version": 1
    },
    {
      "id": "feature-update-only-the-selected-element-the-progress-bowl-canvas-rendered-by-frontend-src-components-progressbowl-tsx-to-remove-the-apparent-top-empty-space-above-the-bowl-by-adjusting-the-canvas-rendering-layout-so-the-bowl-is-vertically-positioned-without-extra-top-margin-blank-area-inside-the-canvas",
      "title": "Update ONLY the selected element (the Progress bowl <canvas> rendered by `frontend/src/components/ProgressBowl.tsx`) to remove the apparent top empty space above the bowl by adjusting the canvas rendering/layout so the bowl is vertically positioned without extra top margin/blank area inside the canvas.",
      "reqIds": [
        "REQ-25"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [],
  "architectural_notes": [
    "Frontend is a SPA using TanStack Router with a manually declared route tree (/, /dashboard, /pre-meditation, /progress, /journal, /books).",
    "Server-state and mutations are managed via TanStack React Query; many query keys are scoped by principal ID (or 'guest') to reduce cache collisions across sessions.",
    "Authentication is encapsulated in an InternetIdentityProvider (Dfinity AuthClient), exposing identity state plus granular login status flags.",
    "Backend access is encapsulated via a react-query-cached canister actor (useActor) that switches between anonymous and identity-bound agents; on actor changes it invalidates/refetches dependent queries.",
    "Guest/offline-first behavior is implemented by branching inside React Query hooks: authenticated users call canister APIs, guests use localStorage via meditationStorage utilities (including legacy-key migration).",
    "Data portability uses a unified JSON export/import structure; exports are downloaded in-browser; imports overwrite guest local data or invoke canister import with overwrite semantics.",
    "Visual identity relies on theme-aware OKLCH design tokens (Tailwind + CSS variables) and multiple animated visualizations (Canvas lotus background, Canvas progress bowl, SVG lotus, optional WebGL via react-three-fiber).",
    "Motoko backend composes capabilities via mixins (authorization/RBAC and blob-storage maintenance endpoints)."
  ],
  "known_issues": [
    "Provider duplication: frontend/src/main.tsx wraps App with QueryClientProvider and InternetIdentityProvider, while frontend/src/App.tsx also wraps Router with its own QueryClientProvider and InternetIdentityProvider. This can create multiple QueryClients/auth contexts and confusing cache/auth behavior.",
    "Backend lacks journal mutation endpoints (create/update/delete/toggle favorite). Frontend journal mutations currently fall back to guest localStorage even when authenticated, so authenticated journal changes are not persisted to the canister.",
    "Authenticated session recording computes streak/monthly minutes client-side from guest localStorage and sends derived values to the backend, which can diverge from backend truth and breaks multi-device consistency.",
    "Backend recordMeditationSession sets ProgressStore.totalMinutes to the client-provided monthly minutes and also sets monthlyMinutes to the same value, effectively overwriting lifetime totals; it also leaves rank empty.",
    "Backend importData overwrite=false path assigns the same id (nextEntryId) to every imported journal entry (does not increment per entry), causing ID collisions.",
    "Guest journal entry IDs are generated using entries.length; deletions can cause ID reuse/collisions leading to incorrect updates/toggles.",
    "Access control initialization depends on CAFFEINE_ADMIN_TOKEN; if missing, _initializeAccessControlWithSecret traps and protected endpoints fail.",
    "Blob-storage cashier env var is spelled \"CAFFFEINE_STORAGE_CASHIER_PRINCIPAL\" (typo with triple 'F'); misconfigured deployments will trap at runtime.",
    "Books are duplicated: backend exposes a Goodreads-based list, but the UI uses a static frontend Amazon-link dataset; the backend getBooks endpoint is currently unused by the UI.",
    "Two global CSS token files exist (frontend/index.css and frontend/src/index.css) with different token sets; only one is imported (src/index.css), which can cause drift/confusion.",
    "Placeholder/empty page modules exist (frontend/src/pages/ActiveMeditationPage.tsx, ReflectionPage.tsx, StatsPage.tsx) while the active/reflection flow is implemented inside PreMeditationPage.",
    "Progress/Journey page: bowl visualization container (or its parent) has excessive top margin/empty space above the bowl; needs margin-top removed (and possibly padding/gap) to reduce unused vertical space."
  ],
  "isFixRequest": true,
  "gameProjectType": "none",
  "projectName": "Inner Bloom",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}